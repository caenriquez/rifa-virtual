<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Rifa 00-99</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f3e5f5;
        text-align: center;
        padding: 20px;
    }
    h1 { color: #4a148c; margin-bottom: 5px; }
    h2 { color: #6a1b9a; font-size: 18px; margin-top: 5px; }
    .info-pago {
        margin-top: 8px;
        font-size: 14px;
        color: #311b92;
        padding: 6px 10px;
        display: inline-block;
        border-radius: 8px;
        background: #ede7f6;
        border: 1px solid #b39ddb;
    }

    /* CONTADOR */
    .countdown {
        margin-top: 18px;
        margin-bottom: 12px;
    }
    .countdown-title {
        font-size: 14px;
        color: #4a148c;
        margin-bottom: 6px;
    }
    .countdown-boxes {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 4px;
    }
    .time-box {
        background: #4527a0;
        color: #fff;
        padding: 8px 10px;
        border-radius: 10px;
        min-width: 70px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .time-box span {
        display: block;
        font-size: 22px;
        font-weight: bold;
    }
    .time-box small {
        display: block;
        font-size: 11px;
        margin-top: 2px;
    }
    .countdown-note {
        font-size: 12px;
        color: #311b92;
    }

    /* PANEL RESULTADOS LOTERÍA */
    .result-panel {
        margin-top: 16px;
        margin-bottom: 10px;
        padding: 10px;
        display: inline-block;
        text-align: left;
        background: #fffde7;
        border-radius: 10px;
        border: 1px solid #ffe082;
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        font-size: 14px;
    }
    .result-panel strong {
        color: #bf360c;
    }
    .result-number {
        font-size: 20px;
        font-weight: bold;
        color: #d84315;
        margin-left: 4px;
    }

    .legend {
        margin: 18px 0 8px 0;
        font-size: 14px;
    }
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin: 0 10px;
    }
    .legend-color {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 1px solid #333;
        margin-right: 5px;
    }

    .resumen {
        margin-bottom: 10px;
        font-size: 16px;
    }

    .download-btn {
        margin-bottom: 20px;
        padding: 6px 14px;
        font-size: 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        background: #3949ab;
        color: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .download-btn:hover {
        background: #283593;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 10px;
        max-width: 520px;
        margin: 0 auto;
    }
    .num {
        background: white;
        border: 2px solid #4a148c;
        font-size: 22px;
        cursor: pointer;
        border-radius: 12px;
        transition: 0.2s;
        user-select: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);

        display: flex;
        align-items: center;
        justify-content: center;
        height: 50px;
    }
    .num:hover {
        background: #e1bee7;
    }

    .reservado {
        background: #ffd54f !important;
        border-color: #ffb300 !important;
    }
    .verificacion {
        background: #64b5f6 !important;
        border-color: #1976d2 !important;
        color: #fff !important;
    }
    .pagado {
        background: #66bb6a !important;
        color: white !important;
        border-color: #2e7d32 !important;
    }
    .ganador {
        box-shadow: 0 0 0 3px #ff5252;
        border-color: #ff1744 !important;
    }

    .admin-panel {
        margin-top: 25px;
        padding: 15px;
        max-width: 520px;
        margin-left: auto;
        margin-right: auto;
        background: #ffffff;
        border-radius: 10px;
        border: 1px solid #ce93d8;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        text-align: left;
        font-size: 14px;
    }
    .admin-panel h3 {
        margin-top: 0;
        text-align: center;
        color: #4a148c;
    }
    .admin-row { margin: 4px 0; }
    .admin-label { font-weight: bold; }
    .admin-buttons {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }
    .admin-btn {
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 13px;
    }
    .btn-liberar   { background: #e53935; color:#fff; }
    .btn-pagado    { background: #43a047; color:#fff; }
    .btn-nombre    { background: #fb8c00; color:#fff; }
    .btn-comprobante { background:#1e88e5; color:#fff; }
    .btn-recibo    { background: #8e24aa; color:#fff; }
    .btn-resultado { background: #d84315; color:#fff; }

    /* Modal selección múltiple */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
    }
    .modal {
        background: #ffffff;
        border-radius: 10px;
        padding: 15px;
        max-width: 420px;
        width: 90%;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        text-align: left;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
    }
    .modal h4 {
        margin: 0 0 8px 0;
        text-align: center;
        color: #4a148c;
    }
    .modal-body {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 6px;
        margin-bottom: 10px;
        font-size: 13px;
    }
    .modal-item {
        display: flex;
        align-items: center;
        padding: 3px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .modal-item:last-child {
        border-bottom: none;
    }
    .modal-item label {
        display: flex;
        align-items: center;
        cursor: pointer;
        width: 100%;
    }
    .modal-item input[type="checkbox"] {
        margin-right: 8px;
    }
    .modal-footer {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
    }
    .modal-btn {
        padding: 6px 10px;
        font-size: 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
    }
    .modal-btn-primary { background:#8e24aa; color:#fff; }
    .modal-btn-secondary { background:#eeeeee; color:#333; }
    .modal-btn-accent { background:#43a047; color:#fff; }
    .modal-btn-warn { background:#e0e0e0; color:#333; }
</style>
</head>
<body>

<h1>Sensacional Rifa de $1.000.000 de pesos</h1>
<h2>Juega el 20 de diciembre de 2025 con la Lotería de Boyacá – Valor del número: $20.000 pesos</h2>
<div class="info-pago">
    Se puede pagar por transferencia a Nequi: <strong>3116403643</strong>
</div>

<!-- CONTADOR REGRESIVO -->
<div class="countdown">
    <div class="countdown-title">Faltan para el sorteo:</div>
    <div class="countdown-boxes">
        <div class="time-box">
            <span id="cdDays">0</span>
            <small>Días</small>
        </div>
        <div class="time-box">
            <span id="cdHours">0</span>
            <small>Horas</small>
        </div>
        <div class="time-box">
            <span id="cdMinutes">0</span>
            <small>Minutos</small>
        </div>
        <div class="time-box">
            <span id="cdSeconds">0</span>
            <small>Segundos</small>
        </div>
    </div>
    <div class="countdown-note">
        Sorteo: sábado 20 de diciembre de 2025 – 10:30 p.m. (Lotería de Boyacá)
    </div>
</div>

<!-- RESULTADO LOTERÍA -->
<div class="result-panel">
    <div>
        <strong>Lotería de Boyacá – Número oficial:</strong>
        <span id="lotFullResult" class="result-number">----</span>
    </div>
    <div>
        <strong>Número ganador de la rifa (2 últimas cifras):</strong>
        <span id="lotLastTwo" class="result-number">--</span>
    </div>
</div>

<p style="margin-top:10px;">
    Solo el administrador puede registrar y gestionar los números.<br>
    Al seleccionar un número se pedirá la contraseña.
</p>

<div class="legend">
    <span class="legend-item">
        <span class="legend-color" style="background:white;"></span> Disponible
    </span>
    <span class="legend-item">
        <span class="legend-color" style="background:#ffd54f;"></span> Reservado / No pagado
    </span>
    <span class="legend-item">
        <span class="legend-color" style="background:#64b5f6;"></span> En verificación
    </span>
    <span class="legend-item">
        <span class="legend-color" style="background:#66bb6a;"></span> Pagado
    </span>
</div>

<div class="resumen">
    Números seleccionados: <strong id="selCount">0</strong> |
    Números libres: <strong id="freeCount">100</strong>
</div>

<button id="btnDescargar" class="download-btn" style="display:none;">
    Descargar consolidado (CSV)
</button>

<div class="grid" id="grid"></div>

<div id="adminPanel" class="admin-panel" style="display:none;">
    <h3>Panel de administración</h3>
    <div class="admin-row">
        <span class="admin-label">Número:</span> <span id="panelNum"></span>
    </div>
    <div class="admin-row">
        <span class="admin-label">Nombre:</span> <span id="panelNombre"></span>
    </div>
    <div class="admin-row">
        <span class="admin-label">Estado:</span> <span id="panelEstado"></span>
    </div>
    <div class="admin-row">
        <span class="admin-label">Comprobante:</span> <span id="panelComprobante"></span>
    </div>
    <div class="admin-row">
        <span class="admin-label">Resultado Boyacá (actual):</span>
        <span id="panelResultado">No registrado</span>
    </div>
    <div class="admin-buttons">
        <button class="admin-btn btn-liberar" id="btnLiberar">Liberar número</button>
        <button class="admin-btn btn-pagado" id="btnPagado">Marcar / desmarcar pagado</button>
        <button class="admin-btn btn-nombre" id="btnNombre">Cambiar nombre</button>
        <button class="admin-btn btn-comprobante" id="btnComprobante">Gestionar comprobante</button>
        <button class="admin-btn btn-recibo" id="btnRecibo">Recibo individual</button>
        <button class="admin-btn btn-recibo" id="btnReciboLote">Recibo múltiple (selección)</button>
        <button class="admin-btn btn-resultado" id="btnResultado">Registrar resultado Boyacá</button>
    </div>
</div>

<!-- MODAL SELECCIÓN MÚLTIPLE -->
<div id="multiModalOverlay" class="modal-overlay">
    <div class="modal">
        <h4>Seleccionar números pagados</h4>
        <div class="modal-body" id="multiList">
            <!-- Aquí se llena la lista de números pagados con checkboxes -->
        </div>
        <div class="modal-footer">
            <button id="multiSelectAll" class="modal-btn modal-btn-secondary">Seleccionar todos</button>
            <button id="multiClear" class="modal-btn modal-btn-warn">Quitar todos</button>
            <button id="multiGenerate" class="modal-btn modal-btn-accent">Generar recibo múltiple</button>
            <button id="multiClose" class="modal-btn modal-btn-primary">Cerrar</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
// ====================== CONFIGURACIÓN ======================
const ADMIN_PASSWORD = "1030";
let esAdmin = false;
const VALOR_NUMERO = 20000;   // $20.000

function formatMoney(num) {
    return "$" + num.toLocaleString("es-CO");
}

const firebaseConfig = {
  apiKey: "AIzaSyC7-pRwzbLgQGkJq1EnO9AcFHPIYKv-1WQ",
  authDomain: "rifa-virtual-af611.firebaseapp.com",
  databaseURL: "https://rifa-virtual-af611-default-rtdb.firebaseio.com",
  projectId: "rifa-virtual-af611",
  storageBucket: "rifa-virtual-af611.firebasestorage.app",
  messagingSenderId: "420485730500",
  appId: "1:420485730500:web:c1adb12167d9a634e1f991",
  measurementId: "G-YXTFSTNZNR"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const grid = document.getElementById("grid");
const estadoActual = {};
const numDivs = {};

const selCountSpan = document.getElementById("selCount");
const freeCountSpan = document.getElementById("freeCount");

const adminPanel = document.getElementById("adminPanel");
const panelNum = document.getElementById("panelNum");
const panelNombre = document.getElementById("panelNombre");
const panelEstado = document.getElementById("panelEstado");
const panelComprobante = document.getElementById("panelComprobante");
const panelResultado = document.getElementById("panelResultado");

const btnLiberar = document.getElementById("btnLiberar");
const btnPagado = document.getElementById("btnPagado");
const btnNombre = document.getElementById("btnNombre");
const btnComprobante = document.getElementById("btnComprobante");
const btnRecibo = document.getElementById("btnRecibo");
const btnDescargar = document.getElementById("btnDescargar");
const btnReciboLote = document.getElementById("btnReciboLote");
const btnResultado = document.getElementById("btnResultado");

// Modal elementos
const multiModalOverlay = document.getElementById("multiModalOverlay");
const multiList = document.getElementById("multiList");
const multiSelectAll = document.getElementById("multiSelectAll");
const multiClear = document.getElementById("multiClear");
const multiGenerate = document.getElementById("multiGenerate");
const multiClose = document.getElementById("multiClose");

// Resultado en pantalla
const lotFullResultSpan = document.getElementById("lotFullResult");
const lotLastTwoSpan = document.getElementById("lotLastTwo");

// Countdown elementos
const cdDays = document.getElementById("cdDays");
const cdHours = document.getElementById("cdHours");
const cdMinutes = document.getElementById("cdMinutes");
const cdSeconds = document.getElementById("cdSeconds");

// Referencias Firebase
const numerosRef = db.ref("numeros");
const resultadoRef = db.ref("resultado");

let numeroSeleccionado = null;
let numeroGanadorActual = null;

// ====================== CONTADOR REGRESIVO ======================
const targetDate = new Date(2025, 11, 20, 22, 30, 0); // 20 dic 2025 22:30

function updateCountdown() {
    const now = new Date().getTime();
    const distance = targetDate.getTime() - now;

    if (distance <= 0) {
        cdDays.textContent = "0";
        cdHours.textContent = "0";
        cdMinutes.textContent = "0";
        cdSeconds.textContent = "0";
        return;
    }

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((distance / (1000 * 60)) % 60);
    const seconds = Math.floor((distance / 1000) % 60);

    cdDays.textContent = days;
    cdHours.textContent = hours.toString().padStart(2, "0");
    cdMinutes.textContent = minutes.toString().padStart(2, "0");
    cdSeconds.textContent = seconds.toString().padStart(2, "0");
}
updateCountdown();
setInterval(updateCountdown, 1000);

// ====================== CREAR GRID 00–99 ======================
for (let i = 0; i < 100; i++) {
    let num = i.toString().padStart(2, "0");
    let div = document.createElement("div");
    div.textContent = num;
    div.classList.add("num");
    numDivs[num] = div;
    div.onclick = () => manejarClickNumero(num);
    grid.appendChild(div);
}

// ====================== SINCRONIZAR NÚMEROS CON FIREBASE ======================
numerosRef.on("value", (snapshot) => {
    const data = snapshot.val() || {};

    for (const k in estadoActual) delete estadoActual[k];

    const seleccionados = Object.keys(data).length;
    const libres = 100 - seleccionados;
    selCountSpan.textContent = seleccionados;
    freeCountSpan.textContent = libres;

    for (let i = 0; i < 100; i++) {
        let n = i.toString().padStart(2, "0");
        let div = numDivs[n];
        div.classList.remove("reservado", "verificacion", "pagado", "ganador");
        div.title = "";
    }

    Object.keys(data).forEach(num => {
        estadoActual[num] = data[num];
        const info = data[num];
        const div = numDivs[num];
        if (!div) return;

        const enVerificacion = !!info.enVerificacion;
        const pagado = !!info.paid;

        if (pagado) {
            div.classList.add("pagado");
        } else if (enVerificacion) {
            div.classList.add("verificacion");
        } else {
            div.classList.add("reservado");
        }

        const estadoTexto = pagado
            ? "PAGADO"
            : (enVerificacion ? "EN VERIFICACION" : "NO PAGADO");

        let extra = "";
        if (info.comprobante) extra = " | Comprobante: " + info.comprobante;

        div.title = `#${num} - ${info.name} - ${estadoTexto}${extra}`;
    });

    // Reaplicar destaque del ganador si existe
    if (numeroGanadorActual !== null && numDivs[numeroGanadorActual]) {
        numDivs[numeroGanadorActual].classList.add("ganador");
    }

    if (numeroSeleccionado !== null) actualizarPanel(numeroSeleccionado);
});

// ====================== SINCRONIZAR RESULTADO LOTERÍA ======================
resultadoRef.on("value", (snapshot) => {
    const data = snapshot.val();
    if (data && data.numero) {
        const full = data.numero;
        const lastTwo = (data.ultimasDos || full.slice(-2)).padStart(2, "0");

        lotFullResultSpan.textContent = full;
        lotLastTwoSpan.textContent = lastTwo;

        panelResultado.textContent = `${full} (rifa: ${lastTwo})`;

        // Quitar ganador anterior
        if (numeroGanadorActual !== null && numDivs[numeroGanadorActual]) {
            numDivs[numeroGanadorActual].classList.remove("ganador");
        }

        numeroGanadorActual = lastTwo;
        if (numDivs[lastTwo]) {
            numDivs[lastTwo].classList.add("ganador");
        }
    } else {
        lotFullResultSpan.textContent = "----";
        lotLastTwoSpan.textContent = "--";
        panelResultado.textContent = "No registrado";

        if (numeroGanadorActual !== null && numDivs[numeroGanadorActual]) {
            numDivs[numeroGanadorActual].classList.remove("ganador");
        }
        numeroGanadorActual = null;
    }
});

// ====================== LÓGICA ADMIN ======================
function solicitarPasswordAdmin() {
    if (esAdmin) return true;
    const intento = prompt("Ingrese la contraseña de administrador:");
    if (intento === null) return false;
    if (intento === ADMIN_PASSWORD) {
        esAdmin = true;
        btnDescargar.style.display = "inline-block";
        return true;
    } else {
        alert("Contraseña incorrecta. No se realizaron cambios.");
        return false;
    }
}

function manejarClickNumero(num) {
    if (!solicitarPasswordAdmin()) return;

    const refNum = db.ref("numeros/" + num);
    const actual = estadoActual[num] || null;

    if (!actual) {
        let name = prompt(`Ingresa el nombre para el número ${num}:`);
        if (!name) return;
        const data = {
            name: name,
            paid: false,
            comprobante: null,
            enVerificacion: false
        };
        refNum.set(data);
        estadoActual[num] = data;
    }

    numeroSeleccionado = num;
    actualizarPanel(num);
    adminPanel.style.display = "block";
}

function actualizarPanel(num) {
    const info = estadoActual[num] || null;
    panelNum.textContent = num;

    if (!info) {
        panelNombre.textContent = "(Libre)";
        panelEstado.textContent = "DISPONIBLE";
        panelComprobante.textContent = "-";
        return;
    }

    panelNombre.textContent = info.name || "(Sin nombre)";

    const enVerificacion = !!info.enVerificacion;
    const pagado = !!info.paid;
    const estadoTexto = pagado
        ? "PAGADO"
        : (enVerificacion ? "EN VERIFICACION" : "NO PAGADO");

    panelEstado.textContent = estadoTexto;
    panelComprobante.textContent = info.comprobante || "-";
}

btnLiberar.onclick = () => {
    if (numeroSeleccionado === null) return;
    if (!esAdmin && !solicitarPasswordAdmin()) return;

    const refNum = db.ref("numeros/" + numeroSeleccionado);
    refNum.remove();
    delete estadoActual[numeroSeleccionado];
    adminPanel.style.display = "none";
    numeroSeleccionado = null;
};

btnPagado.onclick = () => {
    if (numeroSeleccionado === null) return;
    if (!esAdmin && !solicitarPasswordAdmin()) return;

    const actual = estadoActual[numeroSeleccionado];
    if (!actual) return;

    const refNum = db.ref("numeros/" + numeroSeleccionado);
    const nuevoPagado = !actual.paid;
    const actualiza = { paid: nuevoPagado };
    if (nuevoPagado) actualiza.enVerificacion = false;

    refNum.update(actualiza);
    estadoActual[numeroSeleccionado] = { ...actual, ...actualiza };
    actualizarPanel(numeroSeleccionado);
};

btnNombre.onclick = () => {
    if (numeroSeleccionado === null) return;
    if (!esAdmin && !solicitarPasswordAdmin()) return;

    const actual = estadoActual[numeroSeleccionado];
    if (!actual) return;

    let nuevoNombre = prompt("Nuevo nombre para el número " + numeroSeleccionado + ":", actual.name);
    if (!nuevoNombre) return;

    const refNum = db.ref("numeros/" + numeroSeleccionado);
    refNum.update({ name: nuevoNombre });
    estadoActual[numeroSeleccionado].name = nuevoNombre;
    actualizarPanel(numeroSeleccionado);
};

btnComprobante.onclick = () => {
    if (numeroSeleccionado === null) return;
    if (!esAdmin && !solicitarPasswordAdmin()) return;

    const actual = estadoActual[numeroSeleccionado];
    if (!actual) return;

    let textoActual = actual.comprobante || "";
    let nuevoTexto = prompt(
        "Descripción o referencia del comprobante (ej: Nequi #12345, foto enviada por WhatsApp):",
        textoActual
    );

    if (nuevoTexto === null) return;
    nuevoTexto = nuevoTexto.trim();
    const hayComprobante = nuevoTexto.length > 0;

    const refNum = db.ref("numeros/" + numeroSeleccionado);
    const actualiza = {
        comprobante: hayComprobante ? nuevoTexto : null,
        enVerificacion: hayComprobante && !actual.paid
    };

    refNum.update(actualiza);
    estadoActual[numeroSeleccionado] = { ...actual, ...actualiza };
    actualizarPanel(numeroSeleccionado);
};

// ====================== REGISTRAR RESULTADO BOYACÁ (ADMIN) ======================
btnResultado.onclick = () => {
    if (!esAdmin && !solicitarPasswordAdmin()) return;

    let num = prompt("Ingresa el número ganador de la Lotería de Boyacá (ej: 1234 o 56789):");
    if (num === null) return;

    num = num.replace(/\D/g, "");
    if (num.length < 2) {
        alert("Debes ingresar al menos 2 dígitos.");
        return;
    }

    const ultimasDos = num.slice(-2);

    resultadoRef.set({
        numero: num,
        ultimasDos: ultimasDos,
        fecha: new Date().toISOString()
    });
    alert("Resultado registrado. Se actualizará en todos los dispositivos.");
};

// ====================== RECIBO INDIVIDUAL (ALTA RESOLUCIÓN) ======================
btnRecibo.onclick = () => {
    if (numeroSeleccionado === null) {
        alert("Primero selecciona un número en el panel.");
        return;
    }
    if (!esAdmin && !solicitarPasswordAdmin()) return;

    const info = estadoActual[numeroSeleccionado];
    if (!info) {
        alert("El número seleccionado está libre, no hay datos para recibo.");
        return;
    }
    if (!info.paid) {
        alert("Solo se puede descargar recibo si el número está en estado PAGADO.");
        return;
    }

    const num = numeroSeleccionado;
    const nombre = info.name || "";
    const comprobante = info.comprobante || "N/A";
    const fecha = new Date().toLocaleString("es-CO");

    const logicalWidth = 420;
    const logicalHeight = 720;
    const scale = 2;

    const canvas = document.createElement("canvas");
    canvas.width = logicalWidth * scale;
    canvas.height = logicalHeight * scale;
    const ctx = canvas.getContext("2d");
    ctx.scale(scale, scale);

    const grad = ctx.createLinearGradient(0, 0, 0, logicalHeight);
    grad.addColorStop(0, "#7e57c2");
    grad.addColorStop(1, "#ede7f6");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, logicalWidth, logicalHeight);

    const marginX = 30;
    const marginY = 30;
    const ticketWidth = logicalWidth - marginX * 2;
    const ticketHeight = logicalHeight - marginY * 2;

    ctx.fillStyle = "#ffffff";
    ctx.strokeStyle = "#ce93d8";
    ctx.lineWidth = 2;
    const r = 16;

    ctx.beginPath();
    ctx.moveTo(marginX + r, marginY);
    ctx.lineTo(marginX + ticketWidth - r, marginY);
    ctx.quadraticCurveTo(marginX + ticketWidth, marginY, marginX + ticketWidth, marginY + r);
    ctx.lineTo(marginX + ticketWidth, marginY + ticketHeight - r);
    ctx.quadraticCurveTo(marginX + ticketWidth, marginY + ticketHeight, marginX + ticketWidth - r, marginY + ticketHeight);
    ctx.lineTo(marginX + r, marginY + ticketHeight);
    ctx.quadraticCurveTo(marginX, marginY + ticketHeight, marginX, marginY + ticketHeight - r);
    ctx.lineTo(marginX, marginY + r);
    ctx.quadraticCurveTo(marginX, marginY, marginX + r, marginY);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    ctx.save();
    ctx.beginPath();
    const topY = marginY;
    const toothW = 14;
    const toothH = 8;
    for (let x = marginX; x < marginX + ticketWidth; x += toothW) {
        ctx.moveTo(x, topY);
        ctx.lineTo(x + toothW / 2, topY - toothH);
        ctx.lineTo(x + toothW, topY);
    }
    ctx.lineWidth = 1;
    ctx.strokeStyle = "#d1c4e9";
    ctx.stroke();
    ctx.restore();

    let y = marginY + 45;
    ctx.fillStyle = "#4a148c";
    ctx.textAlign = "center";
    ctx.font = "bold 22px Arial";
    ctx.fillText("RECIBO DE PAGO", logicalWidth / 2, y);

    y += 18;
    ctx.strokeStyle = "#e0e0e0";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(marginX + 15, y);
    ctx.lineTo(marginX + ticketWidth - 15, y);
    ctx.stroke();

    y += 28;
    ctx.textAlign = "left";
    ctx.fillStyle = "#311b92";
    ctx.font = "bold 14px Arial";
    const labelX = marginX + 20;
    const valueX = marginX + 150;

    ctx.fillText("Fecha:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText(fecha, valueX, y);

    y += 24;
    ctx.font = "bold 14px Arial";
    ctx.fillText("Número:", labelX, y);
    ctx.font = "bold 18px Arial";
    ctx.fillStyle = "#1e88e5";
    ctx.fillText(num, valueX, y);

    y += 24;
    ctx.font = "bold 14px Arial";
    ctx.fillStyle = "#311b92";
    ctx.fillText("Nombre:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText(nombre, valueX, y);

    y += 24;
    ctx.font = "bold 14px Arial";
    ctx.fillText("Estado:", labelX, y);
    ctx.font = "bold 14px Arial";
    ctx.fillStyle = "#2e7d32";
    ctx.fillText("PAGADO", valueX, y);

    y += 24;
    ctx.font = "bold 14px Arial";
    ctx.fillStyle = "#311b92";
    ctx.fillText("Comprobante:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText(comprobante, valueX, y);

    y += 26;
    ctx.strokeStyle = "#e0e0e0";
    ctx.beginPath();
    ctx.moveTo(marginX + 15, y);
    ctx.lineTo(marginX + ticketWidth - 15, y);
    ctx.stroke();

    y += 26;
    ctx.font = "bold 14px Arial";
    ctx.fillStyle = "#311b92";
    ctx.fillText("Premio:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText(formatMoney(1000000), valueX, y);

    y += 22;
    ctx.font = "bold 14px Arial";
    ctx.fillText("Valor del número:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText(formatMoney(VALOR_NUMERO), valueX, y);

    y += 50;
    ctx.textAlign = "center";
    ctx.font = "italic 13px Arial";
    ctx.fillStyle = "#455a64";
    ctx.fillText("Gracias por participar, buena suerte", logicalWidth / 2, y);

    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/jpeg", 0.95);
    link.download = "recibo_rifa_" + num + ".jpg";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

// ====================== RECIBO MÚLTIPLE CON CHECKBOXES ======================
btnReciboLote.onclick = () => {
    if (!esAdmin && !solicitarPasswordAdmin()) return;

    multiList.innerHTML = "";
    const pagados = [];

    for (let i = 0; i < 100; i++) {
        const num = i.toString().padStart(2, "0");
        const info = estadoActual[num];
        if (info && info.paid) {
            pagados.push({ num, name: info.name || "" });
        }
    }

    if (pagados.length === 0) {
        alert("No hay números en estado PAGADO para generar recibo múltiple.");
        return;
    }

    pagados.forEach(p => {
        const item = document.createElement("div");
        item.className = "modal-item";

        const label = document.createElement("label");

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = p.num;
        checkbox.className = "multi-check";

        const text = document.createElement("span");
        text.textContent = `${p.num} - ${p.name || "Sin nombre"}`;

        label.appendChild(checkbox);
        label.appendChild(text);
        item.appendChild(label);
        multiList.appendChild(item);
    });

    multiModalOverlay.style.display = "flex";
};

multiSelectAll.onclick = () => {
    const checks = multiList.querySelectorAll(".multi-check");
    checks.forEach(ch => ch.checked = true);
};

multiClear.onclick = () => {
    const checks = multiList.querySelectorAll(".multi-check");
    checks.forEach(ch => ch.checked = false);
};

multiClose.onclick = () => {
    multiModalOverlay.style.display = "none";
};

multiGenerate.onclick = () => {
    const checks = multiList.querySelectorAll(".multi-check:checked");
    if (checks.length === 0) {
        alert("Selecciona al menos un número para generar el recibo múltiple.");
        return;
    }

    const seleccionados = Array.from(checks).map(ch => ch.value);

    const numerosUsados = [];
    for (const num of seleccionados) {
        const info = estadoActual[num];
        if (info && info.paid) {
            numerosUsados.push({
                num,
                name: info.name || "",
                comprobante: info.comprobante || "N/A"
            });
        }
    }

    if (numerosUsados.length === 0) {
        alert("Los números seleccionados no están en estado PAGADO.");
        return;
    }

    const nombresUnicos = [...new Set(
        numerosUsados
            .map(p => (p.name || "").trim())
            .filter(Boolean)
    )];

    let nombrePretty;
    if (nombresUnicos.length === 1) {
        nombrePretty = nombresUnicos[0];
    } else if (nombresUnicos.length === 0) {
        nombrePretty = "(Sin nombre)";
    } else {
        nombrePretty = "Varios compradores";
    }

    const cantidad = numerosUsados.length;
    const total = cantidad * VALOR_NUMERO;
    const fecha = new Date().toLocaleString("es-CO");

    const logicalWidth = 420;
    const baseHeight = 420;
    const extraPorNumero = 20;
    const logicalHeight = baseHeight + cantidad * extraPorNumero;
    const scale = 2;

    const canvas = document.createElement("canvas");
    canvas.width = logicalWidth * scale;
    canvas.height = logicalHeight * scale;
    const ctx = canvas.getContext("2d");
    ctx.scale(scale, scale);

    const grad = ctx.createLinearGradient(0, 0, 0, logicalHeight);
    grad.addColorStop(0, "#7e57c2");
    grad.addColorStop(1, "#ede7f6");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, logicalWidth, logicalHeight);

    const marginX = 30;
    const marginY = 30;
    const ticketWidth = logicalWidth - marginX * 2;
    const ticketHeight = logicalHeight - marginY * 2;

    ctx.fillStyle = "#ffffff";
    ctx.strokeStyle = "#ce93d8";
    ctx.lineWidth = 2;
    const r = 16;

    ctx.beginPath();
    ctx.moveTo(marginX + r, marginY);
    ctx.lineTo(marginX + ticketWidth - r, marginY);
    ctx.quadraticCurveTo(marginX + ticketWidth, marginY, marginX + ticketWidth, marginY + r);
    ctx.lineTo(marginX + ticketWidth, marginY + ticketHeight - r);
    ctx.quadraticCurveTo(marginX + ticketWidth, marginY + ticketHeight, marginX + ticketWidth - r, marginY + ticketHeight);
    ctx.lineTo(marginX + r, marginY + ticketHeight);
    ctx.quadraticCurveTo(marginX, marginY + ticketHeight, marginX, marginY + ticketHeight - r);
    ctx.lineTo(marginX, marginY + r);
    ctx.quadraticCurveTo(marginX, marginY, marginX + r, marginY);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    ctx.save();
    ctx.beginPath();
    const topY = marginY;
    const toothW = 14;
    const toothH = 8;
    for (let x = marginX; x < marginX + ticketWidth; x += toothW) {
        ctx.moveTo(x, topY);
        ctx.lineTo(x + toothW / 2, topY - toothH);
        ctx.lineTo(x + toothW, topY);
    }
    ctx.lineWidth = 1;
    ctx.strokeStyle = "#d1c4e9";
    ctx.stroke();
    ctx.restore();

    let y = marginY + 45;
    ctx.fillStyle = "#4a148c";
    ctx.textAlign = "center";
    ctx.font = "bold 20px Arial";
    ctx.fillText("RECIBO DE PAGO", logicalWidth / 2, y);

    y += 18;
    ctx.strokeStyle = "#e0e0e0";
    ctx.beginPath();
    ctx.moveTo(marginX + 15, y);
    ctx.lineTo(marginX + ticketWidth - 15, y);
    ctx.stroke();

    y += 28;
    ctx.textAlign = "left";
    ctx.fillStyle = "#311b92";
    ctx.font = "bold 14px Arial";
    const labelX = marginX + 20;
    const valueX = marginX + 170;

    ctx.fillText("Fecha:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText(fecha, valueX, y);

    y += 24;
    ctx.font = "bold 14px Arial";
    ctx.fillText("Nombre:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText(nombrePretty, valueX, y);

    y += 24;
    ctx.font = "bold 14px Arial";
    ctx.fillText("Premio:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText(formatMoney(1000000), valueX, y);

    y += 22;
    ctx.font = "bold 14px Arial";
    ctx.fillText("Valor del número:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText(formatMoney(VALOR_NUMERO), valueX, y);

    y += 22;
    ctx.font = "bold 14px Arial";
    ctx.fillText("Cantidad de números:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText(String(cantidad), valueX, y);

    y += 22;
    ctx.font = "bold 14px Arial";
    ctx.fillText("Total pagado:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText(formatMoney(total), valueX, y);

    y += 28;
    ctx.strokeStyle = "#e0e0e0";
    ctx.beginPath();
    ctx.moveTo(marginX + 15, y);
    ctx.lineTo(marginX + ticketWidth - 15, y);
    ctx.stroke();

    y += 22;
    ctx.font = "bold 14px Arial";
    ctx.fillText("Números pagados:", labelX, y);
    y += 20;
    ctx.font = "12px Arial";

    const numerosTexto = numerosUsados.map(n => n.num).join(", ");
    const maxAncho = ticketWidth - 40;
    const palabras = numerosTexto.split(" ");
    let linea = "";
    for (let i = 0; i < palabras.length; i++) {
        const testLinea = linea + palabras[i] + " ";
        const anchoTest = ctx.measureText(testLinea).width;
        if (anchoTest > maxAncho) {
            ctx.fillText(linea, labelX, y);
            linea = palabras[i] + " ";
            y += 18;
        } else {
            linea = testLinea;
        }
    }
    if (linea) {
        ctx.fillText(linea, labelX, y);
    }

    y += 40;
    ctx.textAlign = "center";
    ctx.font = "italic 13px Arial";
    ctx.fillStyle = "#455a64";
    ctx.fillText("Gracias por participar, buena suerte", logicalWidth / 2, y);

    const link = document.createElement("a");
    const safeName = nombrePretty.replace(/[^a-zA-Z0-9]+/g, "_") || "varios";
    link.href = canvas.toDataURL("image/jpeg", 0.95);
    link.download = "recibo_rifa_multiple_" + safeName + ".jpg";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    multiModalOverlay.style.display = "none";
};

// ====================== CSV ======================
btnDescargar.onclick = () => {
    if (!esAdmin && !solicitarPasswordAdmin()) return;

    const filas = ['numero,nombre,estado,comprobante'];

    for (let i = 0; i < 100; i++) {
        const num = i.toString().padStart(2, "0");
        const info = estadoActual[num];
        if (!info) continue;

        const enVerificacion = !!info.enVerificacion;
        const pagado = !!info.paid;
        const estado = pagado
            ? "PAGADO"
            : (enVerificacion ? "EN VERIFICACION" : "NO PAGADO");

        const nombre = (info.name || "").replace(/"/g, '""');
        const comp = (info.comprobante || "").replace(/"/g, '""');

        filas.push(`"${num}","${nombre}","${estado}","${comp}"`);
    }

    const csv = filas.join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "rifa_consolidado.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
};
</script>

</body>
</html>
