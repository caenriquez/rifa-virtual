<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Rifa 00-99</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        text-align: center;
        padding: 20px;
    }
    h1 { color: #333; margin-bottom: 5px; }
    h2 { color: #555; font-size: 18px; margin-top: 5px; }
    .info-pago {
        margin-top: 8px;
        font-size: 14px;
        color: #222;
        padding: 6px 10px;
        display: inline-block;
        border-radius: 8px;
        background: #fff3cd;
        border: 1px solid #ffe08a;
    }

    .legend {
        margin: 18px 0 8px 0;
        font-size: 14px;
    }
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin: 0 10px;
    }
    .legend-color {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 1px solid #333;
        margin-right: 5px;
    }

    .resumen {
        margin-bottom: 18px;
        font-size: 16px;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 10px;
        max-width: 520px;
        margin: 0 auto;
    }
    .num {
        background: white;
        border: 2px solid #333;
        padding: 18px;
        font-size: 22px;
        cursor: pointer;
        border-radius: 12px;
        transition: 0.2s;
        user-select: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .num:hover {
        background: #d4f0ff;
    }

    .reservado {
        background: #ffd54f !important; /* amarillo */
        border-color: #ffb300 !important;
    }
    .verificacion {
        background: #64b5f6 !important; /* azul */
        border-color: #1976d2 !important;
        color: #fff !important;
    }
    .pagado {
        background: #4caf50 !important; /* verde */
        color: white !important;
        border-color: #2e7d32 !important;
    }
</style>
</head>
<body>

<h1>Sensacional Rifa de $1.000.000 de pesos</h1>
<h2>Juega el 20 de diciembre de 2025 ‚Äì Valor del n√∫mero: $10.000 pesos</h2>
<div class="info-pago">
    Se puede pagar por transferencia a Nequi: <strong>3116403643</strong>
</div>

<p style="margin-top:18px;">Haz clic en un n√∫mero para asignar nombre. Solo el administrador puede marcarlo como pagado, cambiar el nombre, gestionar el comprobante o liberarlo.</p>

<div class="legend">
    <span class="legend-item">
        <span class="legend-color" style="background:white;"></span> Disponible
    </span>
    <span class="legend-item">
        <span class="legend-color" style="background:#ffd54f;"></span> Reservado / No pagado
    </span>
    <span class="legend-item">
        <span class="legend-color" style="background:#64b5f6;"></span> En verificaci√≥n
    </span>
    <span class="legend-item">
        <span class="legend-color" style="background:#4caf50;"></span> Pagado
    </span>
</div>

<div class="resumen">
    N√∫meros seleccionados: <strong id="selCount">0</strong> |
    N√∫meros libres: <strong id="freeCount">100</strong>
</div>

<div class="grid" id="grid"></div>

<!-- SDK de Firebase (modo compat para que sea sencillo sin m√≥dulos) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
// üîê Contrase√±a de administrador
const ADMIN_PASSWORD = "1030";

// Configuraci√≥n REAL de tu proyecto Firebase
const firebaseConfig = {
  apiKey: "AIzaSyC7-pRwzbLgQGkJq1EnO9AcFHPIYKv-1WQ",
  authDomain: "rifa-virtual-af611.firebaseapp.com",
  databaseURL: "https://rifa-virtual-af611-default-rtdb.firebaseio.com",
  projectId: "rifa-virtual-af611",
  storageBucket: "rifa-virtual-af611.firebasestorage.app",
  messagingSenderId: "420485730500",
  appId: "1:420485730500:web:c1adb12167d9a634e1f991",
  measurementId: "G-YXTFSTNZNR"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const grid = document.getElementById("grid");
const estadoActual = {};   // aqu√≠ guardamos lo que viene de Firebase
const numDivs = {};        // referencia a cada div por n√∫mero

// Referencias a contadores
const selCountSpan = document.getElementById("selCount");
const freeCountSpan = document.getElementById("freeCount");

// Crear los 100 n√∫meros 00‚Äì99
for (let i = 0; i < 100; i++) {
    let num = i.toString().padStart(2, "0");
    let div = document.createElement("div");
    div.textContent = num;
    div.classList.add("num");
    numDivs[num] = div;

    div.onclick = () => {
        manejarClickNumero(num);
    };

    grid.appendChild(div);
}

// Referencia a la colecci√≥n "numeros" en Realtime Database
const numerosRef = db.ref("numeros");

// Escuchar cambios en tiempo real
numerosRef.on("value", (snapshot) => {
    const data = snapshot.val() || {};

    // Actualizar contadores
    const seleccionados = Object.keys(data).length;
    const libres = 100 - seleccionados;
    selCountSpan.textContent = seleccionados;
    freeCountSpan.textContent = libres;

    // Limpiar todos los cuadros a "disponibles"
    for (let i = 0; i < 100; i++) {
        let n = i.toString().padStart(2, "0");
        let div = numDivs[n];
        div.classList.remove("reservado", "verificacion", "pagado");
        div.title = "";
    }

    // Guardar y aplicar estados desde Firebase
    Object.keys(data).forEach(num => {
        estadoActual[num] = data[num];
        const info = data[num];
        const div = numDivs[num];
        if (!div) return;

        div.classList.remove("reservado", "verificacion", "pagado");

        const enVerificacion = !!info.enVerificacion;
        const pagado = !!info.paid;

        if (pagado) {
            div.classList.add("pagado");
        } else if (enVerificacion) {
            div.classList.add("verificacion");
        } else {
            div.classList.add("reservado");
        }

        const estadoTexto = pagado
            ? "PAGADO"
            : (enVerificacion ? "EN VERIFICACI√ìN" : "NO PAGADO");

        let extra = "";
        if (info.comprobante) {
            extra = " | Comprobante: " + info.comprobante;
        }

        div.title = `#${num} - ${info.name} - ${estadoTexto}${extra}`;
    });
});

// Funci√≥n para pedir contrase√±a de administrador
function solicitarPasswordAdmin() {
    const intento = prompt("Ingrese la contrase√±a de administrador:");
    if (intento === null) return false; // Cancelar
    return intento === ADMIN_PASSWORD;
}

// Manejar clic sobre un n√∫mero
function manejarClickNumero(num) {
    const refNum = db.ref("numeros/" + num);
    const actual = estadoActual[num] || null;

    // Si ya est√° asignado, mostrar men√∫ de administrador
    if (actual && actual.name) {
        const estadoTexto = actual.paid
            ? "PAGADO"
            : (actual.enVerificacion ? "EN VERIFICACI√ìN" : "NO PAGADO");

        let opcion = prompt(
            `N√∫mero ${num}\n` +
            `Asignado a: ${actual.name}\n` +
            `Estado: ${estadoTexto}\n` +
            (actual.comprobante ? `Comprobante actual: ${actual.comprobante}\n` : "") +
            `\nEscribe:\n` +
            `1 = Marcar / desmarcar PAGADO\n` +
            `2 = Cambiar nombre\n` +
            `3 = Liberar n√∫mero\n` +
            `4 = Gestionar comprobante / estado de verificaci√≥n\n` +
            `Cancelar = Salir sin cambios`
        );

        if (!opcion) return; // cancelado

        if (!["1", "2", "3", "4"].includes(opcion)) {
            alert("Opci√≥n no v√°lida.");
            return;
        }

        // Solo el admin puede modificar
        if (!solicitarPasswordAdmin()) {
            alert("Contrase√±a incorrecta. No se realizaron cambios.");
            return;
        }

        if (opcion === "1") {
            // Alternar pagado / no pagado
            const nuevoPagado = !actual.paid;
            const actualiza = { paid: nuevoPagado };
            // Si se marca como pagado, dejamos de estar "en verificaci√≥n"
            if (nuevoPagado) {
                actualiza.enVerificacion = false;
            }
            refNum.update(actualiza);
            estadoActual[num] = { ...actual, ...actualiza };
            return;
        }

        if (opcion === "2") {
            // Cambiar nombre
            let nuevoNombre = prompt("Nuevo nombre para el n√∫mero " + num + ":", actual.name);
            if (!nuevoNombre) return;
            refNum.update({ name: nuevoNombre });
            estadoActual[num].name = nuevoNombre;
            return;
        }

        if (opcion === "3") {
            // Liberar n√∫mero
            refNum.remove();
            delete estadoActual[num];
            return;
        }

        if (opcion === "4") {
            // Gestionar comprobante / verificaci√≥n
            let textoActual = actual.comprobante || "";
            let nuevoTexto = prompt(
                "Descripci√≥n o referencia del comprobante (ej: Nequi #12345, foto enviada por WhatsApp):",
                textoActual
            );

            if (nuevoTexto === null) {
                return; // cancelado
            }

            nuevoTexto = nuevoTexto.trim();
            const hayComprobante = nuevoTexto.length > 0;

            const actualiza = {
                comprobante: hayComprobante ? nuevoTexto : null,
                enVerificacion: hayComprobante && !actual.paid
            };

            refNum.update(actualiza);
            estadoActual[num] = { ...actual, ...actualiza };
            return;
        }

        return;
    }

    // Si el n√∫mero est√° libre: cualquier persona puede reservarlo (NO pagado, sin verificaci√≥n todav√≠a)
    let name = prompt(`Ingresa el nombre para el n√∫mero ${num}:`);
    if (!name) return;

    // Preguntar si ya tiene comprobante para dejarlo "en verificaci√≥n"
    let quiereComprobante = confirm(
        "¬øDeseas registrar ahora un comprobante o referencia de pago para dejar el n√∫mero EN VERIFICACI√ìN?\nAceptar = S√≠\nCancelar = No"
    );

    let comprobante = null;
    let enVerificacion = false;

    if (quiereComprobante) {
        let textoComp = prompt(
            "Escribe una descripci√≥n o referencia del comprobante:\n(ej: Nequi #12345, pantallazo enviado por WhatsApp)"
        );
        if (textoComp && textoComp.trim().length > 0) {
            comprobante = textoComp.trim();
            enVerificacion = true;
        }
    }

    const data = {
        name: name,
        paid: false,           // siempre inicia como NO pagado
        comprobante: comprobante,
        enVerificacion: enVerificacion
    };

    refNum.set(data);
    estadoActual[num] = data;
}
</script>

</body>
</html>
