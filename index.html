<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Rifa 00-99</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        text-align: center;
        padding: 20px;
    }
    h1 { color: #333; margin-bottom: 5px; }
    h2 { color: #555; font-size: 18px; margin-top: 5px; }
    .info-pago {
        margin-top: 8px;
        font-size: 14px;
        color: #222;
        padding: 6px 10px;
        display: inline-block;
        border-radius: 8px;
        background: #fff3cd;
        border: 1px solid #ffe08a;
    }

    .legend {
        margin: 18px 0 8px 0;
        font-size: 14px;
    }
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin: 0 10px;
    }
    .legend-color {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 1px solid #333;
        margin-right: 5px;
    }

    .resumen {
        margin-bottom: 10px;
        font-size: 16px;
    }

    .download-btn {
        margin-bottom: 20px;
        padding: 6px 14px;
        font-size: 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        background: #1976d2;
        color: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .download-btn:hover {
        background: #0d47a1;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 10px;
        max-width: 520px;
        margin: 0 auto;
    }
    .num {
        background: white;
        border: 2px solid #333;
        font-size: 22px;
        cursor: pointer;
        border-radius: 12px;
        transition: 0.2s;
        user-select: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);

        /* centrado perfecto */
        display: flex;
        align-items: center;
        justify-content: center;
        height: 50px;
    }
    .num:hover {
        background: #d4f0ff;
    }

    .reservado {
        background: #ffd54f !important; /* amarillo */
        border-color: #ffb300 !important;
    }
    .verificacion {
        background: #64b5f6 !important; /* azul */
        border-color: #1976d2 !important;
        color: #fff !important;
    }
    .pagado {
        background: #4caf50 !important; /* verde */
        color: white !important;
        border-color: #2e7d32 !important;
    }

    /* Panel administrador */
    .admin-panel {
        margin-top: 25px;
        padding: 15px;
        max-width: 520px;
        margin-left: auto;
        margin-right: auto;
        background: #ffffff;
        border-radius: 10px;
        border: 1px solid #ccc;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        text-align: left;
        font-size: 14px;
    }
    .admin-panel h3 {
        margin-top: 0;
        text-align: center;
    }
    .admin-row {
        margin: 4px 0;
    }
    .admin-label {
        font-weight: bold;
    }
    .admin-buttons {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }
    .admin-btn {
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 13px;
    }
    .btn-liberar {
        background: #f44336;
        color: #fff;
    }
    .btn-pagado {
        background: #4caf50;
        color: #fff;
    }
    .btn-nombre {
        background: #ff9800;
        color: #fff;
    }
    .btn-comprobante {
        background: #2196f3;
        color: #fff;
    }
</style>
</head>
<body>

<h1>Sensacional Rifa de $1.000.000 de pesos</h1>
<h2>Juega el 20 de diciembre de 2025 ‚Äì Valor del n√∫mero: $20.000 pesos</h2>
<div class="info-pago">
    Se puede pagar por transferencia a Nequi: <strong>3116403643</strong>
</div>

<p style="margin-top:18px;">
    Solo el administrador puede registrar y gestionar los n√∫meros.<br>
    Al seleccionar un n√∫mero o descargar el consolidado se pedir√° la contrase√±a.
</p>

<div class="legend">
    <span class="legend-item">
        <span class="legend-color" style="background:white;"></span> Disponible
    </span>
    <span class="legend-item">
        <span class="legend-color" style="background:#ffd54f;"></span> Reservado / No pagado
    </span>
    <span class="legend-item">
        <span class="legend-color" style="background:#64b5f6;"></span> En verificaci√≥n
    </span>
    <span class="legend-item">
        <span class="legend-color" style="background:#4caf50;"></span> Pagado
    </span>
</div>

<div class="resumen">
    N√∫meros seleccionados: <strong id="selCount">0</strong> |
    N√∫meros libres: <strong id="freeCount">100</strong>
</div>

<button id="btnDescargar" class="download-btn">
    Descargar consolidado (CSV)
</button>

<div class="grid" id="grid"></div>

<!-- Panel de administraci√≥n -->
<div id="adminPanel" class="admin-panel" style="display:none;">
    <h3>Panel de administraci√≥n</h3>
    <div class="admin-row">
        <span class="admin-label">N√∫mero:</span> <span id="panelNum"></span>
    </div>
    <div class="admin-row">
        <span class="admin-label">Nombre:</span> <span id="panelNombre"></span>
    </div>
    <div class="admin-row">
        <span class="admin-label">Estado:</span> <span id="panelEstado"></span>
    </div>
    <div class="admin-row">
        <span class="admin-label">Comprobante:</span> <span id="panelComprobante"></span>
    </div>
    <div class="admin-buttons">
        <button class="admin-btn btn-liberar" id="btnLiberar">Liberar n√∫mero</button>
        <button class="admin-btn btn-pagado" id="btnPagado">Marcar / desmarcar pagado</button>
        <button class="admin-btn btn-nombre" id="btnNombre">Cambiar nombre</button>
        <button class="admin-btn btn-comprobante" id="btnComprobante">Gestionar comprobante</button>
    </div>
</div>

<!-- SDK de Firebase (modo compat para que sea sencillo sin m√≥dulos) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
// üîê Contrase√±a de administrador
const ADMIN_PASSWORD = "1030";

// Configuraci√≥n REAL de tu proyecto Firebase
const firebaseConfig = {
  apiKey: "AIzaSyC7-pRwzbLgQGkJq1EnO9AcFHPIYKv-1WQ",
  authDomain: "rifa-virtual-af611.firebaseapp.com",
  databaseURL: "https://rifa-virtual-af611-default-rtdb.firebaseio.com",
  projectId: "rifa-virtual-af611",
  storageBucket: "rifa-virtual-af611.firebasestorage.app",
  messagingSenderId: "420485730500",
  appId: "1:420485730500:web:c1adb12167d9a634e1f991",
  measurementId: "G-YXTFSTNZNR"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const grid = document.getElementById("grid");
const estadoActual = {};          // aqu√≠ guardamos lo que viene de Firebase
const numDivs = {};               // referencia a cada div por n√∫mero

// Referencias a contadores
const selCountSpan = document.getElementById("selCount");
const freeCountSpan = document.getElementById("freeCount");

// Panel admin
const adminPanel = document.getElementById("adminPanel");
const panelNum = document.getElementById("panelNum");
const panelNombre = document.getElementById("panelNombre");
const panelEstado = document.getElementById("panelEstado");
const panelComprobante = document.getElementById("panelComprobante");

const btnLiberar = document.getElementById("btnLiberar");
const btnPagado = document.getElementById("btnPagado");
const btnNombre = document.getElementById("btnNombre");
const btnComprobante = document.getElementById("btnComprobante");

// Bot√≥n descargar consolidado
const btnDescargar = document.getElementById("btnDescargar");

// N√∫mero actualmente seleccionado en el panel
let numeroSeleccionado = null;

// Crear los 100 n√∫meros 00‚Äì99
for (let i = 0; i < 100; i++) {
    let num = i.toString().padStart(2, "0");
    let div = document.createElement("div");
    div.textContent = num;
    div.classList.add("num");
    numDivs[num] = div;

    div.onclick = () => {
        manejarClickNumero(num);
    };

    grid.appendChild(div);
}

// Referencia a la colecci√≥n "numeros" en Realtime Database
const numerosRef = db.ref("numeros");

// Escuchar cambios en tiempo real
numerosRef.on("value", (snapshot) => {
    const data = snapshot.val() || {};

    // Limpiar mapa local
    for (const k in estadoActual) {
        delete estadoActual[k];
    }

    // Actualizar contadores
    const seleccionados = Object.keys(data).length;
    const libres = 100 - seleccionados;
    selCountSpan.textContent = seleccionados;
    freeCountSpan.textContent = libres;

    // Limpiar todos los cuadros a "disponibles"
    for (let i = 0; i < 100; i++) {
        let n = i.toString().padStart(2, "0");
        let div = numDivs[n];
        div.classList.remove("reservado", "verificacion", "pagado");
        div.title = "";
    }

    // Guardar y aplicar estados desde Firebase
    Object.keys(data).forEach(num => {
        estadoActual[num] = data[num];
        const info = data[num];
        const div = numDivs[num];
        if (!div) return;

        div.classList.remove("reservado", "verificacion", "pagado");

        const enVerificacion = !!info.enVerificacion;
        const pagado = !!info.paid;

        if (pagado) {
            div.classList.add("pagado");
        } else if (enVerificacion) {
            div.classList.add("verificacion");
        } else {
            div.classList.add("reservado");
        }

        const estadoTexto = pagado
            ? "PAGADO"
            : (enVerificacion ? "EN VERIFICACION" : "NO PAGADO");

        let extra = "";
        if (info.comprobante) {
            extra = " | Comprobante: " + info.comprobante;
        }

        div.title = `#${num} - ${info.name} - ${estadoTexto}${extra}`;
    });

    // Si hay un n√∫mero seleccionado, refrescar el panel
    if (numeroSeleccionado !== null) {
        actualizarPanel(numeroSeleccionado);
    }
});

// Funci√≥n para pedir contrase√±a de administrador
function solicitarPasswordAdmin() {
    const intento = prompt("Ingrese la contrase√±a de administrador:");
    if (intento === null) return false; // Cancelar
    return intento === ADMIN_PASSWORD;
}

// Manejar clic sobre un n√∫mero
function manejarClickNumero(num) {
    // Siempre pedir contrase√±a para acceder
    if (!solicitarPasswordAdmin()) {
        alert("Contrase√±a incorrecta. No se realizaron cambios.");
        return;
    }

    const refNum = db.ref("numeros/" + num);
    const actual = estadoActual[num] || null;

    // Si el n√∫mero est√° libre: registrar nuevo nombre
    if (!actual) {
        let name = prompt(`Ingresa el nombre para el n√∫mero ${num}:`);
        if (!name) return;

        const data = {
            name: name,
            paid: false,
            comprobante: null,
            enVerificacion: false
        };

        refNum.set(data);
        estadoActual[num] = data;
    }

    // Mostrar / actualizar panel para este n√∫mero
    numeroSeleccionado = num;
    actualizarPanel(num);
    adminPanel.style.display = "block";
}

// Actualizar la informaci√≥n mostrada en el panel
function actualizarPanel(num) {
    const info = estadoActual[num] || null;

    panelNum.textContent = num;

    if (!info) {
        panelNombre.textContent = "(Libre)";
        panelEstado.textContent = "DISPONIBLE";
        panelComprobante.textContent = "-";
        return;
    }

    panelNombre.textContent = info.name || "(Sin nombre)";

    const enVerificacion = !!info.enVerificacion;
    const pagado = !!info.paid;

    const estadoTexto = pagado
        ? "PAGADO"
        : (enVerificacion ? "EN VERIFICACION" : "NO PAGADO");

    panelEstado.textContent = estadoTexto;
    panelComprobante.textContent = info.comprobante ? info.comprobante : "-";
}

// --- Acciones de los botones del panel ---

btnLiberar.onclick = () => {
    if (numeroSeleccionado === null) return;
    const refNum = db.ref("numeros/" + numeroSeleccionado);
    refNum.remove();
    delete estadoActual[numeroSeleccionado];
    adminPanel.style.display = "none";
    numeroSeleccionado = null;
};

btnPagado.onclick = () => {
    if (numeroSeleccionado === null) return;
    const actual = estadoActual[numeroSeleccionado];
    if (!actual) return;

    const refNum = db.ref("numeros/" + numeroSeleccionado);
    const nuevoPagado = !actual.paid;
    const actualiza = { paid: nuevoPagado };
    if (nuevoPagado) {
        actualiza.enVerificacion = false;
    }
    refNum.update(actualiza);
    estadoActual[numeroSeleccionado] = { ...actual, ...actualiza };
    actualizarPanel(numeroSeleccionado);
};

btnNombre.onclick = () => {
    if (numeroSeleccionado === null) return;
    const actual = estadoActual[numeroSeleccionado];
    if (!actual) return;

    let nuevoNombre = prompt("Nuevo nombre para el n√∫mero " + numeroSeleccionado + ":", actual.name);
    if (!nuevoNombre) return;

    const refNum = db.ref("numeros/" + numeroSeleccionado);
    refNum.update({ name: nuevoNombre });
    estadoActual[numeroSeleccionado].name = nuevoNombre;
    actualizarPanel(numeroSeleccionado);
};

btnComprobante.onclick = () => {
    if (numeroSeleccionado === null) return;
    const actual = estadoActual[numeroSeleccionado];
    if (!actual) return;

    let textoActual = actual.comprobante || "";
    let nuevoTexto = prompt(
        "Descripci√≥n o referencia del comprobante (ej: Nequi #12345, foto enviada por WhatsApp):",
        textoActual
    );

    if (nuevoTexto === null) {
        return; // cancelado
    }

    nuevoTexto = nuevoTexto.trim();
    const hayComprobante = nuevoTexto.length > 0;

    const refNum = db.ref("numeros/" + numeroSeleccionado);
    const actualiza = {
        comprobante: hayComprobante ? nuevoTexto : null,
        enVerificacion: hayComprobante && !actual.paid
    };

    refNum.update(actualiza);
    estadoActual[numeroSeleccionado] = { ...actual, ...actualiza };
    actualizarPanel(numeroSeleccionado);
};

// --- Descargar consolidado en CSV (solo admin) ---
btnDescargar.onclick = () => {
    if (!solicitarPasswordAdmin()) {
        alert("Contrase√±a incorrecta. No se descargar√° el consolidado.");
        return;
    }

    const filas = ['numero,nombre,estado,comprobante'];

    for (let i = 0; i < 100; i++) {
        const num = i.toString().padStart(2, "0");
        const info = estadoActual[num];
        if (!info) continue; // solo n√∫meros seleccionados

        const enVerificacion = !!info.enVerificacion;
        const pagado = !!info.paid;
        const estado = pagado
            ? "PAGADO"
            : (enVerificacion ? "EN VERIFICACION" : "NO PAGADO");

        const nombre = (info.name || "").replace(/"/g, '""');
        const comp = (info.comprobante || "").replace(/"/g, '""');

        filas.push(`"${num}","${nombre}","${estado}","${comp}"`);
    }

    const csv = filas.join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "rifa_consolidado.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
};
</script>

</body>
</html>
