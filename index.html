<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Rifa 00-99</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        text-align: center;
        padding: 20px;
    }
    h1 { color: #333; margin-bottom: 5px; }
    h2 { color: #555; font-size: 18px; margin-top: 5px; }
    .info-pago {
        margin-top: 8px;
        font-size: 14px;
        color: #222;
        padding: 6px 10px;
        display: inline-block;
        border-radius: 8px;
        background: #fff3cd;
        border: 1px solid #ffe08a;
    }

    .legend {
        margin: 18px 0 8px 0;
        font-size: 14px;
    }
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin: 0 10px;
    }
    .legend-color {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 1px solid #333;
        margin-right: 5px;
    }

    .resumen {
        margin-bottom: 10px;
        font-size: 16px;
    }

    /* üéØ GRID TOTALMENTE CENTRADO */
    .grid-container {
        width: 100%;
        display: flex;
        justify-content: center;
        margin-top: 15px;
    }
    .grid {
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 10px;
        width: 480px;
        max-width: 100%;
    }

    .num {
        background: white;
        border: 2px solid #333;
        padding: 18px;
        font-size: 22px;
        cursor: pointer;
        border-radius: 12px;
        transition: 0.2s;
        user-select: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);

        display: flex;
        align-items: center;
        justify-content: center;
    }
    .num:hover {
        background: #d4f0ff;
    }

    .reservado { background: #ffd54f !important; border-color: #ffb300 !important; }
    .verificacion { background: #64b5f6 !important; border-color: #1976d2 !important; color: #fff !important; }
    .pagado { background: #4caf50 !important; color: white !important; border-color: #2e7d32 !important; }

    .download-btn {
        margin-bottom: 20px;
        padding: 6px 14px;
        font-size: 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        background: #1976d2;
        color: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .download-btn:hover { background: #0d47a1; }

    /* Panel admin */
    .admin-panel {
        margin-top: 25px;
        padding: 15px;
        max-width: 520px;
        margin-left: auto;
        margin-right: auto;
        background: #ffffff;
        border-radius: 10px;
        border: 1px solid #ccc;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        text-align: left;
        font-size: 14px;
    }
    .admin-panel h3 { text-align: center; }
    .admin-row { margin: 4px 0; }
    .admin-label { font-weight: bold; }

    .admin-buttons {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }

    .admin-btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; border: none; }
    .btn-liberar { background: #f44336; color: #fff; }
    .btn-pagado { background: #4caf50; color: #fff; }
    .btn-nombre { background: #ff9800; color: #fff; }
    .btn-comprobante { background: #2196f3; color: #fff; }

</style>
</head>
<body>

<h1>Sensacional Rifa de $1.000.000 de pesos</h1>
<h2>Juega el 20 de diciembre de 2025 ‚Äì Valor del n√∫mero: $20.000 pesos</h2>
<div class="info-pago">
    Se puede pagar por transferencia a Nequi: <strong>3116403643</strong>
</div>

<p>Solo el administrador puede registrar y gestionar los n√∫meros.</p>

<div class="legend">
    <span class="legend-item"><span class="legend-color" style="background:white;"></span>Disponible</span>
    <span class="legend-item"><span class="legend-color" style="background:#ffd54f;"></span>No pagado</span>
    <span class="legend-item"><span class="legend-color" style="background:#64b5f6;"></span>En verificaci√≥n</span>
    <span class="legend-item"><span class="legend-color" style="background:#4caf50;"></span>Pagado</span>
</div>

<div class="resumen">
    N√∫meros seleccionados: <strong id="selCount">0</strong> |
    N√∫meros libres: <strong id="freeCount">100</strong>
</div>

<button id="btnDescargar" class="download-btn">Descargar consolidado (CSV)</button>

<div class="grid-container">
    <div class="grid" id="grid"></div>
</div>

<!-- Panel de administraci√≥n -->
<div id="adminPanel" class="admin-panel" style="display:none;">
    <h3>Panel de administraci√≥n</h3>
    <div><span class="admin-label">N√∫mero:</span> <span id="panelNum"></span></div>
    <div><span class="admin-label">Nombre:</span> <span id="panelNombre"></span></div>
    <div><span class="admin-label">Estado:</span> <span id="panelEstado"></span></div>
    <div><span class="admin-label">Comprobante:</span> <span id="panelComprobante"></span></div>

    <div class="admin-buttons">
        <button class="admin-btn btn-liberar" id="btnLiberar">Liberar</button>
        <button class="admin-btn btn-pagado" id="btnPagado">Pagado</button>
        <button class="admin-btn btn-nombre" id="btnNombre">Cambiar nombre</button>
        <button class="admin-btn btn-comprobante" id="btnComprobante">Comprobante</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>

const ADMIN_PASSWORD = "1030";

firebase.initializeApp({
  apiKey: "AIzaSyC7-pRwzbLgQGkJq1EnO9AcFHPIYKv-1WQ",
  authDomain: "rifa-virtual-af611.firebaseapp.com",
  databaseURL: "https://rifa-virtual-af611-default-rtdb.firebaseio.com",
  projectId: "rifa-virtual-af611",
  storageBucket: "rifa-virtual-af611.firebasestorage.app",
  messagingSenderId: "420485730500",
  appId: "1:420485730500:web:c1adb12167d9a634e1f991"
});

const db = firebase.database();
const estadoActual = {};

const grid = document.getElementById("grid");
const selCountSpan = document.getElementById("selCount");
const freeCountSpan = document.getElementById("freeCount");

// === Crear los 100 n√∫meros ===
for (let i = 0; i < 100; i++) {
    const num = i.toString().padStart(2, "0");
    const div = document.createElement("div");
    div.classList.add("num");
    div.textContent = num;
    div.onclick = () => manejarClick(num);
    grid.appendChild(div);
}

// === Leer Firebase ===
db.ref("numeros").on("value", snap => {
    const data = snap.val() || {};

    Object.keys(data).forEach(k => estadoActual[k] = data[k]);
    Object.keys(estadoActual).forEach(k => { if (!data[k]) delete estadoActual[k] });

    // Contadores
    selCountSpan.textContent = Object.keys(data).length;
    freeCountSpan.textContent = 100 - Object.keys(data).length;

    // Reset estilos
    grid.querySelectorAll(".num").forEach(div => {
        div.classList.remove("reservado","verificacion","pagado");
        div.title = "";
    });

    // Colorear
    for (let num in data) {
        const info = data[num];
        const div = [...grid.children].find(x => x.textContent === num);

        if (info.paid) div.classList.add("pagado");
        else if (info.enVerificacion) div.classList.add("verificacion");
        else div.classList.add("reservado");

        const estado = info.paid
            ? "PAGADO"
            : info.enVerificacion ? "EN VERIFICACION" : "NO PAGADO";

        div.title = `${num} - ${info.name} - ${estado}`;
    }
});

// === Pedir contrase√±a ===
function pedirPass() {
    return prompt("Contrase√±a de administrador:") === ADMIN_PASSWORD;
}

// === Registrar o abrir panel ===
let numeroSeleccionado = null;

function manejarClick(num) {

    if (!pedirPass()) {
        alert("Contrase√±a incorrecta");
        return;
    }

    numeroSeleccionado = num;

    const ref = db.ref("numeros/" + num);

    if (!estadoActual[num]) {
        const nombre = prompt("Nombre para el n√∫mero " + num + ":");
        if (!nombre) return;
        ref.set({ name: nombre, paid: false, enVerificacion:false });
    }

    mostrarPanel(num);
}

// === Panel ===
function mostrarPanel(num) {
    const info = estadoActual[num];

    document.getElementById("panelNum").textContent = num;
    document.getElementById("panelNombre").textContent = info?.name || "(Libre)";
    
    let estado = "DISPONIBLE";
    if (info) {
        if (info.paid) estado = "PAGADO";
        else if (info.enVerificacion) estado = "EN VERIFICACION";
        else estado = "NO PAGADO";
    }
    document.getElementById("panelEstado").textContent = estado;
    document.getElementById("panelComprobante").textContent = info?.comprobante || "-";

    document.getElementById("adminPanel").style.display = "block";
}

// === Acciones del panel ===
document.getElementById("btnLiberar").onclick = () => {
    db.ref("numeros/"+numeroSeleccionado).remove();
    document.getElementById("adminPanel").style.display = "none";
};

document.getElementById("btnPagado").onclick = () => {
    const act = estadoActual[numeroSeleccionado];
    db.ref("numeros/"+numeroSeleccionado).update({
        paid: !act.paid,
        enVerificacion: false
    });
};

document.getElementById("btnNombre").onclick = () => {
    const nuevo = prompt("Nuevo nombre:", estadoActual[numeroSeleccionado].name);
    if (nuevo)
        db.ref("numeros/"+numeroSeleccionado).update({ name: nuevo });
};

document.getElementById("btnComprobante").onclick = () => {
    const actual = estadoActual[numeroSeleccionado];
    let texto = prompt("Comprobante:", actual.comprobante || "");
    if (texto === null) return;

    db.ref("numeros/"+numeroSeleccionado).update({
        comprobante: texto || null,
        enVerificacion: texto && !actual.paid
    });
};

// === Descargar CSV (CON CONTRASE√ëA) ===
document.getElementById("btnDescargar").onclick = () => {

    if (!pedirPass()) {
        alert("Contrase√±a incorrecta");
        return;
    }

    const filas = ["numero,nombre,estado,comprobante"];

    for (let num in estadoActual) {
        const info = estadoActual[num];
        const estado = info.paid
            ? "PAGADO"
            : info.enVerificacion ? "EN VERIFICACION" : "NO PAGADO";

        filas.push(`${num},"${info.name}","${estado}","${info.comprobante||""}"`);
    }

    const csv = filas.join("\n");
    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "rifa_consolidado.csv";
    a.click();

    URL.revokeObjectURL(url);
};

</script>
</body>
</html>

