<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Rifa 00-99</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        text-align: center;
        padding: 20px;
    }
    h1 { color: #333; margin-bottom: 5px; }
    h2 { color: #555; font-size: 18px; margin-top: 5px; }
    .info-pago {
        margin-top: 8px;
        font-size: 14px;
        color: #222;
        padding: 6px 10px;
        display: inline-block;
        border-radius: 8px;
        background: #fff3cd;
        border: 1px solid #ffe08a;
    }

    .legend {
        margin: 18px 0 8px 0;
        font-size: 14px;
    }
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin: 0 10px;
    }
    .legend-color {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 1px solid #333;
        margin-right: 5px;
    }

    .resumen {
        margin-bottom: 10px;
        font-size: 16px;
    }

    .download-btn {
        margin-bottom: 20px;
        padding: 6px 14px;
        font-size: 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        background: #1976d2;
        color: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .download-btn:hover {
        background: #0d47a1;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 10px;
        max-width: 520px;
        margin: 0 auto;
    }
    .num {
        background: white;
        border: 2px solid #333;
        font-size: 22px;
        cursor: pointer;
        border-radius: 12px;
        transition: 0.2s;
        user-select: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);

        /* centrado perfecto */
        display: flex;
        align-items: center;
        justify-content: center;
        height: 50px;
    }
    .num:hover {
        background: #d4f0ff;
    }

    .reservado {
        background: #ffd54f !important; /* amarillo */
        border-color: #ffb300 !important;
    }
    .verificacion {
        background: #64b5f6 !important; /* azul */
        border-color: #1976d2 !important;
        color: #fff !important;
    }
    .pagado {
        background: #4caf50 !important; /* verde */
        color: white !important;
        border-color: #2e7d32 !important;
    }

    /* Panel administrador */
    .admin-panel {
        margin-top: 25px;
        padding: 15px;
        max-width: 520px;
        margin-left: auto;
        margin-right: auto;
        background: #ffffff;
        border-radius: 10px;
        border: 1px solid #ccc;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        text-align: left;
        font-size: 14px;
    }
    .admin-panel h3 {
        margin-top: 0;
        text-align: center;
    }
    .admin-row {
        margin: 4px 0;
    }
    .admin-label {
        font-weight: bold;
    }
    .admin-buttons {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }
    .admin-btn {
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 13px;
    }
    .btn-liberar {
        background: #f44336;
        color: #fff;
    }
    .btn-pagado {
        background: #4caf50;
        color: #fff;
    }
    .btn-nombre {
        background: #ff9800;
        color: #fff;
    }
    .btn-comprobante {
        background: #2196f3;
        color: #fff;
    }
    .btn-recibo {
        background: #9c27b0;
        color: #fff;
    }
</style>
</head>
<body>

<h1>Sensacional Rifa de $1.000.000 de pesos</h1>
<h2>Juega el 20 de diciembre de 2025 con la Loter√≠a de Boyac√° ‚Äì Valor del n√∫mero: $20.000 pesos</h2>
<div class="info-pago">
    Se puede pagar por transferencia a Nequi: <strong>3116403643</strong>
</div>

<p style="margin-top:18px;">
    Solo el administrador puede registrar y gestionar los n√∫meros.<br>
    Al seleccionar un n√∫mero se pedir√° la contrase√±a.
</p>

<div class="legend">
    <span class="legend-item">
        <span class="legend-color" style="background:white;"></span> Disponible
    </span>
    <span class="legend-item">
        <span class="legend-color" style="background:#ffd54f;"></span> Reservado / No pagado
    </span>
    <span class="legend-item">
        <span class="legend-color" style="background:#64b5f6;"></span> En verificaci√≥n
    </span>
    <span class="legend-item">
        <span class="legend-color" style="background:#4caf50;"></span> Pagado
    </span>
</div>

<div class="resumen">
    N√∫meros seleccionados: <strong id="selCount">0</strong> |
    N√∫meros libres: <strong id="freeCount">100</strong>
</div>

<!-- Bot√≥n de consolidado (oculto hasta que se valide la contrase√±a 1030) -->
<button id="btnDescargar" class="download-btn" style="display:none;">
    Descargar consolidado (CSV)
</button>

<div class="grid" id="grid"></div>

<!-- Panel de administraci√≥n -->
<div id="adminPanel" class="admin-panel" style="display:none;">
    <h3>Panel de administraci√≥n</h3>
    <div class="admin-row">
        <span class="admin-label">N√∫mero:</span> <span id="panelNum"></span>
    </div>
    <div class="admin-row">
        <span class="admin-label">Nombre:</span> <span id="panelNombre"></span>
    </div>
    <div class="admin-row">
        <span class="admin-label">Estado:</span> <span id="panelEstado"></span>
    </div>
    <div class="admin-row">
        <span class="admin-label">Comprobante:</span> <span id="panelComprobante"></span>
    </div>
    <div class="admin-buttons">
        <button class="admin-btn btn-liberar" id="btnLiberar">Liberar n√∫mero</button>
        <button class="admin-btn btn-pagado" id="btnPagado">Marcar / desmarcar pagado</button>
        <button class="admin-btn btn-nombre" id="btnNombre">Cambiar nombre</button>
        <button class="admin-btn btn-comprobante" id="btnComprobante">Gestionar comprobante</button>
        <button class="admin-btn btn-recibo" id="btnRecibo">Descargar recibo</button>
    </div>
</div>

<!-- SDK de Firebase (modo compat) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
// üîê Contrase√±a de administrador
const ADMIN_PASSWORD = "1030";
let esAdmin = false;

// Configuraci√≥n Firebase
const firebaseConfig = {
  apiKey: "AIzaSyC7-pRwzbLgQGkJq1EnO9AcFHPIYKv-1WQ",
  authDomain: "rifa-virtual-af611.firebaseapp.com",
  databaseURL: "https://rifa-virtual-af611-default-rtdb.firebaseio.com",
  projectId: "rifa-virtual-af611",
  storageBucket: "rifa-virtual-af611.firebasestorage.app",
  messagingSenderId: "420485730500",
  appId: "1:420485730500:web:c1adb12167d9a634e1f991",
  measurementId: "G-YXTFSTNZNR"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const grid = document.getElementById("grid");
const estadoActual = {};
const numDivs = {};

const selCountSpan = document.getElementById("selCount");
const freeCountSpan = document.getElementById("freeCount");

// Panel admin
const adminPanel = document.getElementById("adminPanel");
const panelNum = document.getElementById("panelNum");
const panelNombre = document.getElementById("panelNombre");
const panelEstado = document.getElementById("panelEstado");
const panelComprobante = document.getElementById("panelComprobante");

const btnLiberar = document.getElementById("btnLiberar");
const btnPagado = document.getElementById("btnPagado");
const btnNombre = document.getElementById("btnNombre");
const btnComprobante = document.getElementById("btnComprobante");
const btnRecibo = document.getElementById("btnRecibo");
const btnDescargar = document.getElementById("btnDescargar");

let numeroSeleccionado = null;

// Crear 00‚Äì99
for (let i = 0; i < 100; i++) {
    let num = i.toString().padStart(2, "0");
    let div = document.createElement("div");
    div.textContent = num;
    div.classList.add("num");
    numDivs[num] = div;
    div.onclick = () => manejarClickNumero(num);
    grid.appendChild(div);
}

const numerosRef = db.ref("numeros");

numerosRef.on("value", (snapshot) => {
    const data = snapshot.val() || {};

    for (const k in estadoActual) delete estadoActual[k];

    const seleccionados = Object.keys(data).length;
    const libres = 100 - seleccionados;
    selCountSpan.textContent = seleccionados;
    freeCountSpan.textContent = libres;

    for (let i = 0; i < 100; i++) {
        let n = i.toString().padStart(2, "0");
        let div = numDivs[n];
        div.classList.remove("reservado", "verificacion", "pagado");
        div.title = "";
    }

    Object.keys(data).forEach(num => {
        estadoActual[num] = data[num];
        const info = data[num];
        const div = numDivs[num];
        if (!div) return;

        div.classList.remove("reservado", "verificacion", "pagado");

        const enVerificacion = !!info.enVerificacion;
        const pagado = !!info.paid;

        if (pagado) {
            div.classList.add("pagado");
        } else if (enVerificacion) {
            div.classList.add("verificacion");
        } else {
            div.classList.add("reservado");
        }

        const estadoTexto = pagado
            ? "PAGADO"
            : (enVerificacion ? "EN VERIFICACION" : "NO PAGADO");

        let extra = "";
        if (info.comprobante) extra = " | Comprobante: " + info.comprobante;

        div.title = `#${num} - ${info.name} - ${estadoTexto}${extra}`;
    });

    if (numeroSeleccionado !== null) actualizarPanel(numeroSeleccionado);
});

function solicitarPasswordAdmin() {
    if (esAdmin) return true;
    const intento = prompt("Ingrese la contrase√±a de administrador:");
    if (intento === null) return false;
    if (intento === ADMIN_PASSWORD) {
        esAdmin = true;
        btnDescargar.style.display = "inline-block";
        return true;
    } else {
        alert("Contrase√±a incorrecta. No se realizaron cambios.");
        return false;
    }
}

function manejarClickNumero(num) {
    if (!solicitarPasswordAdmin()) return;

    const refNum = db.ref("numeros/" + num);
    const actual = estadoActual[num] || null;

    if (!actual) {
        let name = prompt(`Ingresa el nombre para el n√∫mero ${num}:`);
        if (!name) return;
        const data = {
            name: name,
            paid: false,
            comprobante: null,
            enVerificacion: false
        };
        refNum.set(data);
        estadoActual[num] = data;
    }

    numeroSeleccionado = num;
    actualizarPanel(num);
    adminPanel.style.display = "block";
}

function actualizarPanel(num) {
    const info = estadoActual[num] || null;
    panelNum.textContent = num;

    if (!info) {
        panelNombre.textContent = "(Libre)";
        panelEstado.textContent = "DISPONIBLE";
        panelComprobante.textContent = "-";
        return;
    }

    panelNombre.textContent = info.name || "(Sin nombre)";

    const enVerificacion = !!info.enVerificacion;
    const pagado = !!info.paid;
    const estadoTexto = pagado
        ? "PAGADO"
        : (enVerificacion ? "EN VERIFICACION" : "NO PAGADO");

    panelEstado.textContent = estadoTexto;
    panelComprobante.textContent = info.comprobante || "-";
}

// Botones panel
btnLiberar.onclick = () => {
    if (numeroSeleccionado === null) return;
    if (!esAdmin && !solicitarPasswordAdmin()) return;

    const refNum = db.ref("numeros/" + numeroSeleccionado);
    refNum.remove();
    delete estadoActual[numeroSeleccionado];
    adminPanel.style.display = "none";
    numeroSeleccionado = null;
};

btnPagado.onclick = () => {
    if (numeroSeleccionado === null) return;
    if (!esAdmin && !solicitarPasswordAdmin()) return;

    const actual = estadoActual[numeroSeleccionado];
    if (!actual) return;

    const refNum = db.ref("numeros/" + numeroSeleccionado);
    const nuevoPagado = !actual.paid;
    const actualiza = { paid: nuevoPagado };
    if (nuevoPagado) actualiza.enVerificacion = false;

    refNum.update(actualiza);
    estadoActual[numeroSeleccionado] = { ...actual, ...actualiza };
    actualizarPanel(numeroSeleccionado);
};

btnNombre.onclick = () => {
    if (numeroSeleccionado === null) return;
    if (!esAdmin && !solicitarPasswordAdmin()) return;

    const actual = estadoActual[numeroSeleccionado];
    if (!actual) return;

    let nuevoNombre = prompt("Nuevo nombre para el n√∫mero " + numeroSeleccionado + ":", actual.name);
    if (!nuevoNombre) return;

    const refNum = db.ref("numeros/" + numeroSeleccionado);
    refNum.update({ name: nuevoNombre });
    estadoActual[numeroSeleccionado].name = nuevoNombre;
    actualizarPanel(numeroSeleccionado);
};

btnComprobante.onclick = () => {
    if (numeroSeleccionado === null) return;
    if (!esAdmin && !solicitarPasswordAdmin()) return;

    const actual = estadoActual[numeroSeleccionado];
    if (!actual) return;

    let textoActual = actual.comprobante || "";
    let nuevoTexto = prompt(
        "Descripci√≥n o referencia del comprobante (ej: Nequi #12345, foto enviada por WhatsApp):",
        textoActual
    );

    if (nuevoTexto === null) return;
    nuevoTexto = nuevoTexto.trim();
    const hayComprobante = nuevoTexto.length > 0;

    const refNum = db.ref("numeros/" + numeroSeleccionado);
    const actualiza = {
        comprobante: hayComprobante ? nuevoTexto : null,
        enVerificacion: hayComprobante && !actual.paid
    };

    refNum.update(actualiza);
    estadoActual[numeroSeleccionado] = { ...actual, ...actualiza };
    actualizarPanel(numeroSeleccionado);
};

// --- Recibo en JPG tipo tiquete peque√±o ---
btnRecibo.onclick = () => {
    if (numeroSeleccionado === null) {
        alert("Primero selecciona un n√∫mero en el panel.");
        return;
    }
    if (!esAdmin && !solicitarPasswordAdmin()) return;

    const info = estadoActual[numeroSeleccionado];
    if (!info) {
        alert("El n√∫mero seleccionado est√° libre, no hay datos para recibo.");
        return;
    }
    if (!info.paid) {
        alert("Solo se puede descargar recibo si el n√∫mero est√° en estado PAGADO.");
        return;
    }

    const num = numeroSeleccionado;
    const nombre = info.name || "";
    const comprobante = info.comprobante || "N/A";
    const fecha = new Date().toLocaleString("es-CO");

    // Canvas tipo tique
    const canvas = document.createElement("canvas");
    canvas.width = 420;   // ancho reducido
    canvas.height = 720;  // alto reducido
    const ctx = canvas.getContext("2d");

    // Fondo suave
    const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
    grad.addColorStop(0, "#e3f2fd");
    grad.addColorStop(1, "#ffffff");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Ticket blanco
    const marginX = 30;
    const marginY = 30;
    const ticketWidth = canvas.width - marginX * 2;
    const ticketHeight = canvas.height - marginY * 2;

    ctx.fillStyle = "#ffffff";
    ctx.strokeStyle = "#cfd8dc";
    ctx.lineWidth = 2;
    const r = 16;

    ctx.beginPath();
    ctx.moveTo(marginX + r, marginY);
    ctx.lineTo(marginX + ticketWidth - r, marginY);
    ctx.quadraticCurveTo(marginX + ticketWidth, marginY, marginX + ticketWidth, marginY + r);
    ctx.lineTo(marginX + ticketWidth, marginY + ticketHeight - r);
    ctx.quadraticCurveTo(marginX + ticketWidth, marginY + ticketHeight, marginX + ticketWidth - r, marginY + ticketHeight);
    ctx.lineTo(marginX + r, marginY + ticketHeight);
    ctx.quadraticCurveTo(marginX, marginY + ticketHeight, marginX, marginY + ticketHeight - r);
    ctx.lineTo(marginX, marginY + r);
    ctx.quadraticCurveTo(marginX, marginY, marginX + r, marginY);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    // "Dientes" arriba
    ctx.save();
    ctx.beginPath();
    const topY = marginY;
    const toothW = 14;
    const toothH = 8;
    for (let x = marginX; x < marginX + ticketWidth; x += toothW) {
        ctx.moveTo(x, topY);
        ctx.lineTo(x + toothW / 2, topY - toothH);
        ctx.lineTo(x + toothW, topY);
    }
    ctx.lineWidth = 1;
    ctx.strokeStyle = "#e0e0e0";
    ctx.stroke();
    ctx.restore();

    // T√≠tulo
    let y = marginY + 45;
    ctx.fillStyle = "#263238";
    ctx.textAlign = "center";
    ctx.font = "bold 22px Arial";
    ctx.fillText("RECIBO DE RIFA", canvas.width / 2, y);

    // L√≠nea
    y += 18;
    ctx.strokeStyle = "#eceff1";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(marginX + 15, y);
    ctx.lineTo(marginX + ticketWidth - 15, y);
    ctx.stroke();

    // Campos
    y += 28;
    ctx.textAlign = "left";
    ctx.fillStyle = "#263238";
    ctx.font = "bold 14px Arial";
    const labelX = marginX + 20;
    const valueX = marginX + 150;

    ctx.fillText("Fecha:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText(fecha, valueX, y);

    y += 24;
    ctx.font = "bold 14px Arial";
    ctx.fillText("N√∫mero:", labelX, y);
    ctx.font = "bold 18px Arial";
    ctx.fillStyle = "#1e88e5";
    ctx.fillText(num, valueX, y);

    y += 24;
    ctx.font = "bold 14px Arial";
    ctx.fillStyle = "#263238";
    ctx.fillText("Nombre:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText(nombre, valueX, y);

    y += 24;
    ctx.font = "bold 14px Arial";
    ctx.fillText("Estado:", labelX, y);
    ctx.font = "bold 14px Arial";
    ctx.fillStyle = "#2e7d32";
    ctx.fillText("PAGADO", valueX, y);

    y += 24;
    ctx.font = "bold 14px Arial";
    ctx.fillStyle = "#263238";
    ctx.fillText("Comprobante:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText(comprobante, valueX, y);

    // Separador
    y += 26;
    ctx.strokeStyle = "#eceff1";
    ctx.beginPath();
    ctx.moveTo(marginX + 15, y);
    ctx.lineTo(marginX + ticketWidth - 15, y);
    ctx.stroke();

    // Premio y valor
    y += 26;
    ctx.font = "bold 14px Arial";
    ctx.fillStyle = "#263238";
    ctx.fillText("Premio:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText("$1.000.000", valueX, y);

    y += 22;
    ctx.font = "bold 14px Arial";
    ctx.fillText("Valor del n√∫mero:", labelX, y);
    ctx.font = "12px Arial";
    ctx.fillText("$20.000", valueX, y);

    // Mensaje final
    y += 50;
    ctx.textAlign = "center";
    ctx.font = "italic 13px Arial";
    ctx.fillStyle = "#455a64";
    ctx.fillText("Gracias por participar, buena suerte", canvas.width / 2, y);

    // Descargar JPG
    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/jpeg", 0.95);
    link.download = "recibo_rifa_" + num + ".jpg";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

// CSV consolidado
btnDescargar.onclick = () => {
    if (!esAdmin && !solicitarPasswordAdmin()) return;

    const filas = ['numero,nombre,estado,comprobante'];

    for (let i = 0; i < 100; i++) {
        const num = i.toString().padStart(2, "0");
        const info = estadoActual[num];
        if (!info) continue;

        const enVerificacion = !!info.enVerificacion;
        const pagado = !!info.paid;
        const estado = pagado
            ? "PAGADO"
            : (enVerificacion ? "EN VERIFICACION" : "NO PAGADO");

        const nombre = (info.name || "").replace(/"/g, '""');
        const comp = (info.comprobante || "").replace(/"/g, '""');

        filas.push(`"${num}","${nombre}","${estado}","${comp}"`);
    }

    const csv = filas.join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "rifa_consolidado.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
};
</script>

</body>
</html>
